---
title: "Portfolio Performance"
output: html_notebook
---

# Nedela polnoc - deadline na ulohu
# daniel.gabris@zurich.com

# https://github.com/ex-man/GeneralInsurance_Class/blob/Class2023/Lessons/Lesson3/README.md


# Portfolio performance

```{r}
# install.packages('tidyverse')
library(tidyverse)
dt_KPI <- read_csv("./Data/lesson3_KPI.csv")
```

## Computing ratios
So far we have looked at the absolute numbers. Now we will start looking more at the data from performance perspective.

Now from what you have learned so far, try to create expense ratio for the whole dataset (single number for the whole insurance company).

```{r}
dt_KPI %>%
  summarise(
    LR = sum(Losses) / sum(Premium),
    ER = sum(Expenses) / sum(Premium),
    COR = ER + LR
  )
```

Now create loss ratio, combined ratio and underwriting result for each data record. Every row of the dataset represents a combination of Region, Unit, Segment, Business and Year.

```{r}
dt_KPI %>%
  mutate(
    LR = Losses / Premium,
    ER = Expenses / Premium,
    COR = LR + ER,
    UWR = Premium - (Losses + Expenses)
  ) %>%
  arrange(LR) %>% 
  select(Region, Unit, Segment, Business, Year, LR, COR, UWR)
```

Which of the records has the best performance in terms of individual KPIs?

### Regional analysis
Looking at the metrics for individual rows might be too detailed. We can try to look from a more high level perspective. Let's start with regional analysis where we look at the data in some geographic perspective. Mainly because of the local regulations, laws and accounting.

Now we will have a look at the performance of our insurance company by regions.

Which region is performing the best when we look at the individual KPIs?

```{r}
dt_KPI %>%
  group_by(Region) %>%
  summarise(
    ER = sum(Expenses) / sum(Premium),
    LR = sum(Losses) / sum(Premium),
    COR = ER + LR,
    UWR = sum(Premium) - sum(Losses + Expenses)
  ) %>%
  arrange(COR)
```

Many times we are interested to see how the business is doing in time. It is nice if the company is historically profitable but it is also important to see if we are currently profitable.

Let's see how the single regions perform in time. Create a chart that shows a particular KPI of a single region in time.

Pick KPI of your choice.

```{r}
dt_KPI %>% 
  group_by(Region, Year) %>% 
  summarise(LR = sum(Losses) / sum(Premium)) %>%
  ggplot(aes(x = Year, y = LR, color = Region)) +
  geom_line()
```

How would you describe what you see in the chart? What can it mean what you see in the chart?


### Unit analysis
Let's have a look at the analysis on a different level. Let's see how the units are performing. Prepare KPIs for each unit (i.e. prepare expense ratio, loss ratio, combined ratio and underwriting result). Which unit performs the best?

```{r}
dt_KPI %>%
  group_by(Unit) %>%
  summarise(
    ER = sum(Expenses) / sum(Premium),
    LR = sum(Losses) / sum(Premium),
    COR = ER + LR,
    UWR = sum(Premium) - sum(Losses + Expenses)
  ) %>%
  arrange(desc(UWR))
```

Now prepare a chart that shows you how the separate units perform in time. Let's look at the UW result.

You can also try using `geom_point` in addition to the `geom_line`

```{r}
dt_KPI %>% 
  group_by(Unit, Year) %>% 
  summarise(UWR = sum(Premium) - sum(Losses + Expenses)) %>%
  ggplot(aes(x = Year, y = UWR, color = Unit)) +
  geom_line() + 
  geom_point()
```

Looking at the overall unit performance, we can check how well did the units fulfilled their plans. Create a variable where you calculate to what extent a single unit achieved to meet its plan.

```{r}
dt_KPI %>%
  mutate(UWR = Premium - (Losses + Expenses)) %>%
  mutate(UWRvsP = UWR - UWR_Plan) %>%
  group_by(Unit, Year) %>%
  summarize(UWRvsP = sum(UWRvsP)) %>%
  ggplot(aes(x = Year, y = UWRvsP, color = Unit)) +
  geom_line() + 
  geom_point()
```

### Segment and business analysis

Over time, insurance companies are also interested in how the market looks like. We would like to know how specific segments (ie personal, small businesses, large businesses etc) perform.

Create KPIs for segments and analyze it in time. Do the same for business.

This will be your homework (for some of you). Make sure to review both Lesson 2 and Lesson 3 materials while solving the homework exercise.

### Homework assignment
```{r}
set.seed(123)
students <- c("Student1", "Student2", "Student3")
assignments <- paste0("Zadanie", sample(1:8, size=length(students)))
assignments <- setNames(assignments, students)
dput(assignments)
# c(Student1 = "Zadanie7", Student2 = "Zadanie8", Student3 = "Zadanie3")
```


---
title: "Data Preparation"
output: html_notebook
---

# Policy and Claims data exploration

As mentioned in previous lessons, we identified good and bad performers in terms of portfolios. To identify which group of people/companies are guilty of that performance we need **more granular data**. And so we received *Claims* and *Policy* data from our IT department.

Let's look at them.

### Join Claims with Policy info
It is obvious we need to join both dataset together as __claims data__ contains info about __how risky__ is the individual client. __Policy data__ contains info about individual's features and other identifiers, which might help us to find reasons for __why__ client __is riskier__.

So let's find out the way how to join them together.

```{r}
#install.packages('tidyverse')
library(dplyr)
library(lubridate) # for working with dates
```

Policy data are at *policy + object* level.

```{r}
dt_Policy <- read.csv("./Data/lesson4_PolicyHistory.csv") %>% 
  distinct(NrPolicy, NrObject, .keep_all = TRUE)

dt_Policy %>% head(5)

dt_Policy %>%
  group_by(NrPolicy) %>%
  mutate(n = n()) %>%
  filter(n > 1)
```

Claims data are at *claims* level. 

```{r}
dt_Claims <- read.csv("./Data/lesson4_Claims.csv") %>% 
  distinct(NrClaim, .keep_all = TRUE)

dt_Claims %>% head(5)
```

To properly bring the claims info on `policy + object` level, we need to ensure claims data are also on that level. Let's check it and if they are not, roll them up to that level. (The claims could for example be on a transactional level).

```{r}
# Extract claim year
dt_Claims <- dt_Claims %>% 
  mutate(Date_of_loss = lubridate::dmy(Date_of_loss)) %>% 
  mutate(ClmYr = lubridate::year(Date_of_loss))

# TODO: Get number of records in dt_Claims
dt_Claims %>% nrow()
dt_Policy %>% nrow()

# TODO: Get number of distinct records in dt_Claims at level (NrPolicy, NrObject)
# Hint: use distinct()
dt_Claims %>% distinct(NrPolicy, NrObject) %>% nrow()
dt_Claims %>% group_by(NrPolicy, NrObject) %>% mutate(n=n()) %>% filter(n>1)

# TODO: Get number of distinct records in dt_Claims at level (NrPolicy, NrObject, ClmYr)
dt_Claims %>% distinct(NrPolicy, NrObject, ClmYr) %>% nrow()
```

Claims data are on the required level, since the number of distinct rows at that level is the same as the total number of rows. If this was not the case, we could roll the data up as follows:

```{r}
dt_Claims %>% 
  group_by(NrPolicy, NrObject, ClmYr) %>% 
  summarise_at(vars(Paid, Reserves), list(sum), na.rm = TRUE) %>% nrow()
```


Cool! Let's finally join policies and claims together.

```{r}
dt_pol_w_claims <- dt_Policy %>% 
  left_join(dt_Claims, by = c("NrPolicy", "NrObject"))

dt_pol_w_claims %>% head(3)

dt_pol_w_claims %>% filter(!is.na(NrClaim)) %>% head(5)
```

Perfect! So what now? Hmm...

Let's look how successful we have been in finding out about our client losses.

### Quality Assurance of Join
```{r}
# How many claims did we merge?

# TODO: Compute the percentage of rows in dt_pol_w_claims with null/non-null NrClaim 
# Hint: use is.na(NrClaim)
dt_pol_w_claims %>% nrow()
dt_pol_w_claims %>% filter(!is.na(NrClaim)) %>% nrow()
```

Does it look good or bad? Two questions should arise in your head:

  - Is there any better way to join those information together? Am I missing anything? Does the IT provide good data pull?
  - Let's suppose everything looks good in your join. Does it make sense to you to have such number of claims for portfolio you are analysing? If you are not sure, you should ask your business or claims department.

# Looking for a good Target

#### ...and what is the Target?
Target is a __dependent__ variable in a model you designed for the purpose of being helpful in predicting the insurance event. Good design of the model can answer questions about relationship between any __independent__ variables and target. When we spoke about _variable_ it can be anything which is __measurable__ (event, object, facts, idea, ...).

Questions which might help you identify good target and design good model:

- What is the event, object or idea you would like to predict?
- Is it measurable?
- Let's say you finished your model, how did the prediction help you to solve your insurance issue?
- Are there any potential independent variables that might have relationship to your target you propose?

> Now the crucial questions: What are you going to model and what data will you need for that purpose?



Write a few sentences about what you think and commit your notes.



#### Exercise 2
Go to Exercise 2 and try to think about what could be a good 'target'/ event you are trying to predict from data you have.

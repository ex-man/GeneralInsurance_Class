---
title: "Data preparation for lesson 2 (KPI's, searching for bad looking portfolios)"
output:
  html_notebook:
    df_print: paged
    number_sections: yes
    toc: yes
---

# Setup

[Lesson 2 on Github](https://github.com/ex-man/GeneralInsurance_Class/blob/Class2023/Lessons/Lesson2/README.md)

## Load libraries

```{r}
# libraries
# install.packages("tidyr")
library(dplyr)
library(ggplot2)
library(tidyr)
```

## Load data

```{r}
# load data and replace empty strings with expliti NAs
dt_KPI_raw <- read.csv("./Data/lesson2_KPI.csv")
dt_KPI_raw[dt_KPI_raw==""]<-NA
```

# Data inspection
## What type of information do we have?
> Hint: To have a quick overview of data use glimpse() function from dplyr

```{r}
dt_KPI_raw %>% glimpse() # or glimpse(dt_KPI_raw)
```

It is good to know what your data contains and what the column names mean,
usually Data Governance team could help you with this question.
For now let's assume we know what our columns mean.

## What do the columns contain?
> Hint: The function summary() might help you to answer this question

```{r}
dt_KPI_raw %>% summary()
```

# Looking for defects in data 
## Are there any missing values?
As a first task, try to find missings for a specific column only
```{r}
# Select a column from dataset (e.g. Business)
# Use appropriate function(s) to detect missing values
# Count the missing values

#Business == NA # nefunguje
is.na(dt_KPI_raw) %>% sum()
#dt_KPI_raw$Business
#dt_KPI_raw$Business
#dt_KPI_raw[["Business"]]
is.na(dt_KPI_raw$Business) %>% sum()
is.na(dt_KPI_raw$Business) %>% mean()*100
#is.na(dt_KPI_raw$Region) %>% which() %>% length()
```

Can you generalize this process for the whole dataset? 
> Hint: Can you use any kind of loop here?

```{r}
# Your code
for(column in names(dt_KPI_raw)) {
  print(column)
  print(is.na(dt_KPI_raw[[column]]) %>% sum())
}
```

Are there any values that don't make any sense in the context of the data? 
Which values are not allowed for specific columns? Let's have a look at individual columns.
> Hint: Be prepared to deal with continuous and categorical values as well

```{r}
dt_KPI_raw %>% summary()
```

# Correction of defects 
## What is the feasible way to repair missing values? 
> Hint: Have a look at function na.omit

```{r}
dt_KPI_clean <- dt_KPI_raw %>% na.omit()
dt_KPI_clean
```

## What is the feasible way to repair values that don't make sense?
> Hint: Look at numeric columns

```{r}
dt_KPI_clean %>% summary()

dt_KPI_clean <- dt_KPI_clean %>%
  mutate(
    Premium = abs(Premium),
    Expenses = abs(Expenses),
    Losses = abs(Losses)
  )

dt_KPI_clean %>% summary()
```

# Inspecting basic insurance metrics
We talked about three basic insurance metrics - Premium, Losses and Expenses. We can sum these up to see the overall statistics of our dataset (insurance company).

```{r}
dt_KPI_clean %>%
  summarize(
    Premium = sum(Premium),
    Losses = sum(Losses),
    Expenses = sum(Expenses)
  )
```

# Visualization of Raw Data 
*What makes sense to visualize (or compare using some visualization) in terms of KPIs?*
Reflection - take a moment and think about what makes sense to look into.

## Data preparation for visualization
### Which Unit has collected the most Premium? 

```{r}
dt_KPI_clean %>%
  group_by(Unit) %>%
  summarize(Premium = sum(Premium)) %>%
  arrange(desc(Premium))
```

### Which Unit has the lowest Expenses? 
```{r}
dt_KPI_clean %>%
  group_by(Unit) %>%
  summarize(Expenses = sum(Expenses)) %>%
  arrange(Expenses)
```

### Which Business from Unit found in the previous task had the highest Expenses? 
```{r}
dt_KPI_clean %>%
  filter(Unit == "Unit8") %>%
  group_by(Business) %>%
  summarize(Expenses = sum(Expenses)) %>%
  arrange(desc(Expenses))
```

## Basic Visualization

Visualize your findings on simple bar charts - ggplot2::geom_col()

### Which Unit has collected the most Premium? 
```{r}
dt_KPI_clean %>%
  group_by(Unit) %>%
  summarize(
    Premium = sum(Premium),
    Expenses = sum(Expenses),
    Losses = sum(Losses)
  ) %>%
  ggplot(aes(
    x = reorder(Unit,-Premium),
    y = Premium,
    group = 1
  )) +
  # geom_line(), geom_point(), geom_hist(), ...
  geom_col() +
  geom_line() +
  geom_point()
```

### Which Unit has the lowest Expenses? 
```{r}
dt_KPI_clean %>%
  group_by(Unit) %>%
  summarize(
    Premium = sum(Premium),
    Expenses = sum(Expenses),
    Losses = sum(Losses)
  ) %>%
  ggplot(aes(x = reorder(Unit, Expenses), y = Expenses)) +
  geom_col() 
```

### Which Business from Unit found in the previous task had the highest Expenses? 
```{r}
dt_KPI_clean %>%
  filter(Unit == "Unit5") %>%
  group_by(Business) %>%
  summarize(
    Premium = sum(Premium),
    Expenses = sum(Expenses),
    Losses = sum(Losses)
  ) %>%
  ggplot(aes(x = reorder(Business,-Expenses), y = Expenses)) +
  geom_col()
```

### Bonus - Show all Costs Insurance Company has as a stacked bar for Expenses and Losses grouped by Units

Summarize Expenses and Losses at Unit level:

```{r}
dt_by_unit <- dt_KPI_clean %>%
  group_by(Unit) %>%
  summarise(
    Expenses = sum(Expenses),
    Losses = sum(Losses))

dt_by_unit
```

Pivot summarized data to long form: (if you are getting an error, you might need to install the tidyr package using `install.packages("tidyr")`)

```{r}
dt_by_unit_longer <- dt_by_unit %>%
  tidyr::pivot_longer(-Unit, names_to = "Type", values_to = "Value")

dt_by_unit_longer
```

Visualise as stacked bar chart:

```{r}
dt_by_unit_longer %>%
  ggplot(aes(x = Unit, y = Value, fill = Type)) +
  geom_col()
```
We can use the argument `position` of `geom_col` function to arrange the bars to be side by side.

```{r}
dt_by_unit_longer %>%
  ggplot(aes(x = Unit, y = Value, fill = Type)) +
  geom_col(position = "dodge")
```

We can also use a different value for this argument to normalize values to [0.0, 1.0] within each x-axis category (Unit).

```{r}
dt_by_unit_longer %>%
  ggplot(aes(x = Unit, y = Value, fill = Type)) +
  geom_col(position = "fill")
```

Reflection - take a moment and think which is the best and the worst Unit performer. Feel free to do more data exploration.
